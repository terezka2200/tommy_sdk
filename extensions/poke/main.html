<div class="content-block-title">Current Employees</div>
<div id="ext-poke-users" class="list-block">
  <ul></ul>
</div>

<!-- About Popup -->
<div class="content-block">
  <a href="#" class="button open-popup" data-popup=".popup-poke-about">About This Extension</a>
</div>

<!-- About Popup -->
<div class="popup popup-poke-about">
  <div class="content-block">
    <h3>About</h3>
    <p>
      This is the <strong>Poke</strong> extension in action!
      This code is a good starting point for building your own extensions that interact with the
      <a href="http://api.mytommy.com" target="_blank" class="external">Tommy API</a>.
    </p>
    <p>
      It retreives a list of employees from the Tommy API,
      and sends the employee a <i>Poke</i> message notification when you
      click on their name - just to make sure they're not slacking off :)
    </p>
    <p>
      The source code is located in <code>/extensions/poke</code>
    </p>
    <p><a href="#" class="close-popup">Close popup</a></p>
  </div>
</div>

<script type="javascript">
  // Instantiate the Tommy API
  var tommy = new Tommy.API();

  // Show a loading indicator
  myApp.showPreloader('Loading Employees...');

  // Get a list of accessible account employees from the API
  tommy.get('/employees', {}, function(err, res) {
    myApp.hidePreloader();

    console.log('employees response', err, res);
    if (err) {
      alert('API error: Could not fetch employees');
      return;
    }

    // Add each of the users to the view
    for (i = 0; i < res.length; i++) {
      var employee = res[i];

      // Create the list item
      var navItem = $('<li><a href="#' + employee.id + '" class="item-link">' +
        '<div class="item-content">' +
          '<div class="item-inner">' +
            '<div class="item-title">' +
              employee.user.first_name + ' ' + employee.user.last_name +
            '</div>' +
          '</div>' +
        '</div></a></li>');

      navItem.find('a').click(function(){
        myApp.alert('Would you like to poke ' + employee.user.first_name + '?',
                    'Confirm', function() {
          pokeUser(employee.user)
        });
        return false;
      });

      // Add the sidebar menu
      $('#ext-poke-users ul').append(navItem);
    }
  });

  function pokeUser(receiver) {
    tommy.create('/chat_messages', {
        receiver_id: receiver.id,
        message: 'You\'ve been Poked!'}, function(err, res) {
      console.log('send message response', err, res);
      if (err) {
        alert('API error: Could not send message');
        return;
      }

      myApp.addNotification({
        message: ('You have poked ' + receiver.first_name + '!')
      });
    });
  }
</script>
