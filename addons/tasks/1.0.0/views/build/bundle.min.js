!function s(o,r,d){function l(e,t){if(!r[e]){if(!o[e]){var a="function"==typeof require&&require;if(!t&&a)return a(e,!0);if(c)return c(e,!0);var n=new Error("Cannot find module '"+e+"'");throw n.code="MODULE_NOT_FOUND",n}var i=r[e]={exports:{}};o[e][0].call(i.exports,function(t){return l(o[e][1][t]||t)},i,i.exports,s,o,r,d)}return r[e].exports}for(var c="function"==typeof require&&require,t=0;t<d.length;t++)l(d[t]);return l}({1:[function(t,e,a){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var n,i=t("./controllers/index"),s=(n=i)&&n.__esModule?n:{default:n};var r={listsLoaded:!1,tasksLoaded:!1,cache:{},initCache:function(){r.cache={lists:{},tasks:{}}},getOrderedLists:function(){var t=Object.values(r.cache.lists);return t.length?t.sort(function(t,e){return t.data.order-e.data.order}):[]},addTask:function(t){r.cache.tasks[t.id]=t,console.log("task added",t)},addTasks:function(t){if(r.tasksLoaded=!0,t&&t.length)for(var e=0;e<t.length;e++)Array.isArray(t[e])?r.addTasks(t[e]):r.addTask(t[e])},getListTasks:function(t){var n=r.cache.lists[t],i=[];for(var e in r.cache.tasks){var s=r.cache.tasks[e];n.filters&&s.filters&&function(){var t=s.filters.map(function(t){return t.name}),e=n.filters.map(function(t){return t.name}),a=t.filter(function(t){return-1!==e.indexOf(t)});console.log("should add task to list",s.name,n.name,a),a.length&&i.push(s)}()}return i},loadTasks:function(){console.log("load tasks");var t=void 0,e=void 0,a=void 0,n=[];for(var i in r.cache.lists){var s=r.cache.lists[i];if(t=[window.tommy.config.getCurrentUserName()],console.log(window.tommy.config.getCurrentUser()),s.data&&s.filters)for(var o=0;o<s.filters.length;o++)t.push(s.filters[o].name);e={addon:"tasks",kind:"Task",tags:t},a=window.tommy.api.getFragments(e),n.push(a)}return Promise.all(n).then(r.addTasks)},addTaskActivity:function(t,e,a){var n=window.tommy.config.getCurrentUser(),i={type:e,text:a,time:new Date,user_id:n.id,user_name:n.first_name};return t.data||(t.data={}),t.data.activity||(t.data.activity=[]),t.data.activity.unshift(i),i},saveTask:function(t){if(console.log("save task",t),t.name){t.addon="tasks",t.kind="Task",t.id||r.addTaskActivity(t,"status",window.tommy.i18n.t("task.created_a_task")),t.start_at||(t.start_at=(new Date).getTime());var e=Object.assign({},t,{data:JSON.stringify(t.data)});return t.id?window.tommy.api.updateFragment(t.id,e).then(r.addTask):window.tommy.api.createFragment(e).then(r.addTask)}alert("Task name must be set")},addList:function(t){r.cache.lists[t.id]=t,console.log("added task list",t)},addLists:function(t){if(r.listsLoaded=!0,t&&t.length)for(var e=0;e<t.length;e++)r.addList(t[e])},loadLists:function(t){return console.log("load task lists",t),t=Object.assign({addon:"tasks",kind:"TaskList"},t),window.tommy.api.getFragments(t).then(r.addLists)},deleteList:function(t){return delete r.cache.lists[t],console.log("delete list",t),window.tommy.api.deleteFragment(t)},saveList:function(t){console.log("save list",t),s.default.invalidateLists=!0,t.addon="tasks",t.kind="TaskList",t.data||(t.data={}),void 0===t.data.order&&(t.data.order=Object.keys(r.cache.lists).length),void 0===t.data.active&&(t.data.active=!0),void 0===t.data.show_fast_add&&(t.data.show_fast_add=!0);var e=Object.assign({},t,{data:JSON.stringify(t.data)});return t.id?window.tommy.api.updateFragment(t.id,e).then(r.addList):window.tommy.api.createFragment(e).then(r.addList)},currentUserTag:function(){return{context:"members",name:window.tommy.config.getCurrentUserName(),user_id:window.tommy.config.getCurrentUserId()}},createDefaultList:function(){console.log("creating deafult task list");var t={name:window.tommy.i18n.t("index.default-task-name"),data:{default:!0},filters:[r.currentUserTag()]};return r.saveList(t)},hasLists:function(){return 0<Object.keys(r.cache.lists).length},initPermissionSelects:function(a,n){window.tommy.api.getInstalledAddonPermissions("tasks",{cache:!0}).then(function(t){console.log("installed addon permissions",t),t=t.filter(function(t){return-1!==n.indexOf(t.name)});for(var e=0;e<t.length;e++)console.log("init permissions",t[e]),window.tommy.tplManager.appendInline("tasks__tagSelectTemplate",t[e],a.container),r.initTagSelect(a,t[e])})},initTagSelect:function(t,e){var a=$$(t.container).find('.tag-select[data-permission-name="'+e.name+'"]');console.log("init tag select",e,a.dataset()),window.tommy.tagSelect.initWidget(a,e.filters,function(t){console.log("save tags",e,t),window.tommy.api.updateInstalledAddonPermission("tasks",e.name,{filters:JSON.stringify(t)})})},isTablet:function(){return 630<=window.innerWidth}};a.default=r},{"./controllers/index":3}],2:[function(t,e,a){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var n,i=t("../api"),s=(n=i)&&n.__esModule?n:{default:n};var o={init:function(t){var e=$$(t.container),a=$$(t.navbarInnerContainer);window.tommy.tplManager.renderInline("tasks__boardSettingTemplate",null,e),s.default.initPermissionSelects(t,["task_create_access","task_edit_access"]),a.find("a.save").on("click",function(t){window.tommy.app.f7.formToJSON(e.find("form"));t.preventDefault()})},saveList:function(){},afterSave:function(t){}};a.default=o},{"../api":1}],3:[function(t,e,a){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var o=n(t("../api")),i=n(t("./task"));function n(t){return t&&t.__esModule?t:{default:t}}var r={init:function(t){console.log("initialize tasks addon"),o.default.listsLoaded&&o.default.tasksLoaded?r.invalidate(t):(o.default.initCache(),o.default.loadLists().then(function(){o.default.hasLists()?o.default.loadTasks().then(function(){r.invalidate(t)}):o.default.createDefaultList().then(function(){o.default.loadTasks().then(function(){r.invalidate(t)})})})),r.bind(t)},uninit:function(){console.log("uninitialize tasks addon"),o.default.cache={}},bind:function(n){var t=$$(n.container);t.find(".list-content").each(function(){var t=$$(this);t[0].scrollHeight>=t[0].clientHeight&&t.parent().addClass("hasScroll")}),t.on("click",".fast-add-toggle",function(){var t=$$(this),e=t.closest(".in").removeClass("in").siblings().addClass("in");t.data("input-focus")&&e.find("input").focus()}),t.on("submit","form.fast-add-form",function(t){t.preventDefault();var e=o.default.cache.lists[$$(this).parents("[data-list-id]").data("list-id")],a=window.tommy.app.f7.formToJSON(this);a.filters=e.filters,$$(this).find('input[name="name"]').val(""),o.default.saveTask(a).then(function(){r.invalidate(n)})}),$$(document).on("picker:open",function(t){var e=$$(t.target);if(e.hasClass("tag-select-picker")){var a=window.tommy.config.getCurrentUserName();e.find('input[value="'+a+'"]').parent().parent().addClass("offscreen")}}),t.on("click","a.task-card",function(){var a=$$(this).data("href");o.default.isTablet()?$$.get(a,function(t){var e=$$('<div class="popup" data-page="tasks__task" id="tasks__tasks"></div>');e.append(t),e.find(".back").removeClass("back"),e.find(".page").addClass("navbar-fixed"),window.tommy.f7.popup(e),i.default.init({container:e.find(".page")[0],navbarInnerContainer:e.find(".navbar-inner")[0],query:$$.parseUrlQuery(a)})}):window.tommy.f7view.router.loadPage($$(this).data("href"))})},invalidate:function(t){console.log("invalidating tasks index");var e=$$(t.container);if(r.invalidateLists||!e.find(".card").length){r.invalidateLists=!1,window.tommy.tplManager.renderInline("tasks__listsTemplate",o.default.getOrderedLists(),t.container);window.tommy.app.f7.swiper(".swiper-container",{centeredSlides:!o.default.isTablet(),spaceBetween:0,freeMode:!1,freeModeSticky:!0,slidesPerView:"auto"})}for(var a in o.default.cache.lists){var n=$$(t.container).find('[data-list-id="'+a+'"] .list-content'),i=o.default.getListTasks(a);window.tommy.tplManager.renderTarget("tasks__listTasksTemplate",i,n)}var s=window.tommy.addons.getCurrentActor();s&&window.tommy.app.setPageTitle(window.tommy.i18n.t("index.title_user",{user:s.first_name}))}};a.default=r},{"../api":1,"./task":8}],4:[function(t,e,a){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var n,i=t("../api"),s=(n=i)&&n.__esModule?n:{default:n};var o={init:function(t){var a=$$(t.container);$$(t.navbarInnerContainer).find("a.save").on("click",function(t){var e=window.tommy.app.f7.formToJSON(a.find("form"));o.saveList(e),t.preventDefault()})},saveList:function(t){var e={};e.name=t.name,s.default.saveList(e).then(o.afterSave)},afterSave:function(t){console.log("list saved",t),window.tommy.app.f7view.router.back()}};a.default=o},{"../api":1}],5:[function(t,e,a){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var i=n(t("../api")),s=n(t("./index"));function n(t){return t&&t.__esModule?t:{default:t}}var o={init:function(e){var a=i.default.cache.lists[e.query.list_fragment_id],n=$$(e.container),t=$$(e.navbarInnerContainer);console.log("edit list",a),window.tommy.tplManager.renderInline("tasks__listEditTemplate",a,n),o.initListFilters(e,a),i.default.initPermissionSelects(e,["task_list_read_access","task_list_edit_access"]),t.find("a.save").on("click",function(t){var e=window.tommy.app.f7.formToJSON(n.find("form"));o.saveList(a,e),t.preventDefault()}),n.find(".date-range-select").on("click",function(t){o.showDateRangePopup(e,a),t.preventDefault()}),n.find(".delete-list").on("click",function(t){i.default.deleteList(a.id),s.default.invalidateLists=!0,window.tommy.app.f7view.router.back(),t.preventDefault()})},showDateRangePopup:function(t,e){var a=window.tommy.tplManager.render("tasks__dateRangeSelectTemplate",e.data);window.tommy.f7.popup(a)},initListFilters:function(t,e){var a={title:window.tommy.i18n.t("parmissions.filter_tasks.title"),name:"filter_tasks"},n=window.tommy.tplManager.appendInline("tasks__tagSelectTemplate",a,t.container);console.log("init filter select",e.filters),window.tommy.tagSelect.initWidget(n,e.filters,function(t){console.log("save filter tags",t),e.filters=t})},saveList:function(t,e){t.name=e.name,t.data.show_fast_add=!(!e.show_fast_add||!e.show_fast_add.length),i.default.saveList(t).then(o.afterSave)},afterSave:function(t){console.log("list saved",t),window.tommy.app.f7view.router.back()}};a.default=o},{"../api":1,"./index":3}],6:[function(t,e,a){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var n,i=t("../api"),s=(n=i)&&n.__esModule?n:{default:n};var o={init:function(a){var n=$$(a.container),t=$$(a.navbarInnerContainer);window.tommy.tplManager.renderInline("tasks__listManagementTemplate",s.default.getOrderedLists(),n),t.find("a.save").on("click",function(t){var e=window.tommy.app.f7.formToJSON(n.find("form"));o.save(a,e),t.preventDefault()})},save:function(t,e){var a=$$(t.container),i=!1;a.find(".sortable [data-list-id]").each(function(t){var e=$$(this),a=s.default.cache.lists[e.data("list-id")],n=e.find('input[type="checkbox"]')[0].checked;console.log("save list order",a.name,a.data.order,t,a.data.active,n),a.data.order==t&&a.data.active==n||(a.data.order=t,a.data.active=n,s.default.saveList(a),console.log("updated list",a),i||(i=!0,window.tommy.app.f7view.router.back()))})}};a.default=o},{"../api":1}],7:[function(t,e,a){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var n,i=t("../api"),s=(n=i)&&n.__esModule?n:{default:n};var o={init:function(t){var a=$$(t.container),e=$$(t.navbarInnerContainer);window.tommy.tplManager.renderInline("tasks__addTaskTemplate",{},a),e.find("a.save").on("click",function(t){var e=window.tommy.app.f7.formToJSON(a.find("form"));e.filters=[s.default.currentUserTag()],o.saveTask(e),t.preventDefault()})},saveTask:function(t){s.default.saveTask(t).then(o.afterSave)},afterSave:function(t){console.log("task saved",t),window.tommy.app.f7view.router.back()}};a.default=o},{"../api":1}],8:[function(t,e,a){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var n,i=t("../api"),r=(n=i)&&n.__esModule?n:{default:n};var d={init:function(a){var e=r.default.cache.tasks[a.query.task_fragment_id],t=$$(a.container),n=$$(a.navbarInnerContainer);console.log("init task details",e),window.tommy.tplManager.renderInline("tasks__taskDetailsTemplate",e,t.parent()),t.find(".task-menu-popover").on("popover:open",function(){$$(window).trigger("resize")}),t.find(".task-menu-popover a").click(function(t){var e=$$(t.target).data("command");switch(e){case"add-checklist":d.renderChecklist(a);break;case"add-end-time":d.renderDeadline(a);break;default:alert("Unknown command: "+e)}window.tommy.app.f7.closeModal(".task-menu-popover")}),t.find(".page-content").scroll(function(t){100<t.target.scrollTop?n.addClass("with-title"):n.removeClass("with-title")}),d.initStatusPicker(a),e.data.checklist&&e.data.checklist.items&&d.renderChecklist(a),e.end_at&&d.renderDeadline(a);var i=window.tommy.app.f7.messagebar(".messagebar",{maxHeight:200});t.find(".add-comment").click(function(){d.addActivity(a,"comment",i.value()),i.clear()}),d.renderActivity(a);var s=t.find(".tag-select"),o=[];e.filters&&(o=e.filters),console.log("init task participants",o,s.length),window.tommy.tplManager.renderInline("tasks__taskParticipantsTemplate",o,t),window.tommy.tagSelect.initWidget(s,o,function(t){console.log("task participants changed",t),e.filters=t,window.tommy.tplManager.renderInline("tasks__taskParticipantsTemplate",e.filters,a.container),d.enableSave(a,!0)}),t.find("input.edit-task-name").on("click",function(){d.enableEditName(a,!0)}),t.find("textarea.edit-task-description").on("click",function(){d.enableEditDescription(a,!0)}),n.find("a.save").on("click",function(){d.saveTask(a),d.enableSave(a,!1)}),d.invalidate(a)},invalidate:function(t){var e=r.default.cache.tasks[t.query.task_fragment_id];$$(t.navbarInnerContainer).find(".center").text(e.name)},renderActivity:function(t){var e=r.default.cache.tasks[t.query.task_fragment_id],a=$$(t.container),n=[];e.data.activity&&(n=e.data.activity),window.tommy.tplManager.renderInline("tasks__taskActivityTemplate",n,a)},addActivity:function(t,e,a){var n=r.default.cache.tasks[t.query.task_fragment_id];r.default.addTaskActivity(n,e,a),d.renderActivity(t),d.saveTask(t)},renderChecklist:function(a){var n=r.default.cache.tasks[a.query.task_fragment_id],t=$$(a.container),e=[];n.data.checklist&&n.data.checklist.items&&(e=n.data.checklist.items),window.tommy.tplManager.renderInline("tasks__taskChecklistTemplate",e,t);var i=t.find("input.add-checklist-item");i.on("focusout",function(){var t=$$(this).val();t&&t.length&&(n.data.checklist||(n.data.checklist={}),n.data.checklist.items||(n.data.checklist.items=[]),n.data.checklist.items.push({text:t,complete:!1}),d.renderChecklist(a))}),i.on("focusin",function(){d.enableSave(a)}),t.find(".remove-checklist").click(function(){n.data.checklist={},t.find('[data-template="tasks__taskChecklistTemplate"]').html(""),d.saveTask(a)}),t.find(".remove-checklist-item").click(function(){var t=parseInt($$(this).parents("li").data("checklist-item"));console.log("removing checklist item",t),n.data.checklist.items.splice(t,1),d.renderChecklist(a),d.enableSave(a)}),t.find(".checklist-item").click(function(){var t=parseInt($$(this).parents("li").data("checklist-item")),e=$$(this).hasClass("checked");console.log("toggle checklist item",t),e?($$(this).removeClass("checked"),n.data.checklist.items[t].complete=!1):($$(this).addClass("checked"),n.data.checklist.items[t].complete=!0),d.enableSave(a)})},renderDeadline:function(t){var e=r.default.cache.tasks[t.query.task_fragment_id],a=$$(t.container);console.log("render deadline",e.end_at),window.tommy.tplManager.renderInline("tasks__taskDeadlineTemplate",e.end_at,a);var n=a.find("input.edit-task-deadline"),i=window.tommy.util.createDatePicker(n,e.end_at,{onClose:function(){console.log("closing deadline picker",i.currentDate),e.end_at=i.currentDate,d.enableSave(t)},onFormat:function(t){return console.log("format deadline picker",t),window.tommy.util.humanTime(t)}});e.end_at||n.val(""),a.on("click",".remove-deadline",function(){delete e.end_at,a.find('[data-template="tasks__taskDeadlineTemplate"]').html(""),d.saveTask(t)})},STATUS:["Unassigned","Assigned","Processing","Completed","Closed","Archive Task","Cancel"],translateStatus:function(t){return window.tommy.i18n.t("status."+window.tommy.util.underscore(t))},untranslateStatus:function(t){for(var e=0;e<d.STATUS.length;e++)if(d.translateStatus(d.STATUS[e])===t)return d.STATUS[e]},translatedStatuses:function(t){for(var e=[],a=0;a<d.STATUS.length;a++)e.push(d.translateStatus(d.STATUS[a]));return e},initStatusPicker:function(n){var i=r.default.cache.tasks[n.query.task_fragment_id],t=i.status?d.translateStatus(i.status):void 0;return window.tommy.app.f7.picker({input:$$(n.container).find(".task-status-picker"),value:[t],convertToPopover:!1,cols:[{textAlign:"center",values:d.translatedStatuses()}],onClose:function(t){var e=t.value[0],a=d.untranslateStatus(t.value[0]);a!=i.status&&(i.status=a,d.addActivity(n,"status",window.tommy.i18n.t("task.changed_status_to",{status:e})),d.saveTask(n))}})},saveTask:function(t){var e=r.default.cache.tasks[t.query.task_fragment_id];console.log("saving task fragment",e),r.default.saveTask(e)},enableEditName:function(t,e){var a=r.default.cache.tasks[t.query.task_fragment_id],n=$$(t.container).find("input.edit-task-name");0!=e&&(d.enableSave(t,!0),n.on("focusout",function(){a.name=n.val(),console.log("set task name",a.name)}))},enableEditDescription:function(t,e){var a=r.default.cache.tasks[t.query.task_fragment_id],n=$$(t.container).find("textarea.edit-task-description");0!=e&&(d.enableSave(t,!0),n.on("focusout",function(){a.data.description=n.val(),console.log("set task description",a.data.description),d.enableEditDescription(t,!1)}))},enableSave:function(t,e){var a=$$(t.navbarInnerContainer).find("a.save");0!=e?(a.siblings().hide(),a.css("display","flex")):(a.siblings().css("display","flex"),a.hide())}};a.default=d},{"../api":1}],9:[function(t,e,a){"use strict";var n=c(t("./controllers/index")),i=c(t("./controllers/task")),s=c(t("./controllers/task-add")),o=c(t("./controllers/list-add")),r=c(t("./controllers/list-edit")),d=c(t("./controllers/list-management")),l=c(t("./controllers/board-settings"));function c(t){return t&&t.__esModule?t:{default:t}}window.tommy.app.f7.onPageInit("tasks__index",n.default.init),window.tommy.app.f7.onPageBack("tasks__index",n.default.uninit),window.tommy.app.f7.onPageAfterAnimation("tasks__index",n.default.invalidate),window.tommy.app.f7.onPageInit("tasks__board-settings",l.default.init),window.tommy.app.f7.onPageInit("tasks__list-add",o.default.init),window.tommy.app.f7.onPageInit("tasks__list-edit",r.default.init),window.tommy.app.f7.onPageInit("tasks__list-management",d.default.init),window.tommy.app.f7.onPageAfterAnimation("tasks__list-management",d.default.init),window.tommy.app.f7.onPageInit("tasks__task-add",s.default.init),window.tommy.app.f7.onPageInit("tasks__task",i.default.init),window.tommy.app.f7.onPageAfterAnimation("tasks__task",i.default.invalidate),window.tommy.app.t7.registerHelper("tasks__checklistNumCompleted",function(t){var e="";t&&t.items&&(e+=t.items.filter(function(t){return t.complete}).length,e+="/",e+=t.items.length);return e}),window.tommy.app.t7.registerHelper("tasks__displayStatus",function(t){return window.tommy.i18n.t("status."+window.tommy.util.underscore(t),{defaultValue:t})}),window.tommy.app.t7.registerHelper("tasks__displayDateRange",function(t){return t})},{"./controllers/board-settings":2,"./controllers/index":3,"./controllers/list-add":4,"./controllers/list-edit":5,"./controllers/list-management":6,"./controllers/task":8,"./controllers/task-add":7}]},{},[9]);